<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½èœå•è§„åˆ’ä¸éšæœºç‚¹é¤ - æœ¬åœ°ç‰ˆ</title>
    <!-- å¼•å…¥ Tailwind CSS ä»¥å®ç°å¿«é€Ÿã€å“åº”å¼çš„ç§»åŠ¨ç«¯ç•Œé¢è®¾è®¡ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å¼•å…¥ Inter å­—ä½“ä»¥è·å¾—ç°ä»£æ„Ÿå’Œæ›´å¥½çš„ç§»åŠ¨ç«¯æ˜¾ç¤º */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* å¼ºåˆ¶ä¸»å®¹å™¨åœ¨å°å±å¹•ä¸Šå æ»¡å®½åº¦å¹¶ç¡®ä¿é«˜åº¦è¶³å¤Ÿ */
        #app-container {
            min-height: 100vh;
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ï¼Œç”¨äºèœå•åˆ—è¡¨ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #a5b4fc;
            border-radius: 2px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app-container" class="w-full max-w-2xl mx-auto bg-white shadow-2xl rounded-2xl p-6 sm:p-8 lg:p-10">

        <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">ğŸ½ï¸ æ™ºèƒ½èœå•è§„åˆ’</h1>
        
        <!-- æœ¬åœ°æ¨¡å¼æç¤ºæ¨ªå¹… -->
        <div class="p-3 mb-4 rounded-lg text-sm font-medium bg-yellow-100 text-yellow-700">
            âš ï¸ å½“å‰ä½¿ç”¨**æœ¬åœ°å­˜å‚¨æ¨¡å¼**ï¼Œæ•°æ®ä»…ä¿å­˜åœ¨æœ¬è®¾å¤‡æµè§ˆå™¨ä¸­ã€‚
        </div>

        <p class="text-sm text-gray-500 mb-6 border-b pb-4">
            æ•°æ®å­˜å‚¨çŠ¶æ€: 
            <span id="user-id-display" class="font-mono text-xs bg-gray-100 px-1 py-0.5 rounded">æœ¬åœ°å­˜å‚¨ (Local Storage)</span>
        </p>

        <div id="main-content" class="space-y-10">
            
            <!-- 1. èœå•æ·»åŠ åŒº -->
            <section class="border border-indigo-200 rounded-xl p-4 bg-indigo-50">
                <h2 class="text-xl font-bold text-indigo-700 mb-4">âœ¨ æ·»åŠ æ–°èœå•</h2>
                <div class="space-y-3">
                    <input type="text" id="dish-name" placeholder="è¾“å…¥èœå (ä¾‹å¦‚: å®«ä¿é¸¡ä¸)" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <input type="text" id="dish-category" placeholder="è¾“å…¥åˆ†ç±» (ä¾‹å¦‚: å·èœ, ç´ é£Ÿ, æ—©é¤)" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <button onclick="saveDish()" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01]">
                        ä¿å­˜èœå• ğŸ’¾
                    </button>
                    <p id="save-message" class="text-sm text-center pt-1"></p>
                </div>
            </section>

            <!-- 2. èœå•æ¨è/éšæœºç‚¹é¤åŒº -->
            <section class="border border-green-200 rounded-xl p-4 bg-green-50">
                <h2 class="text-xl font-bold text-green-700 mb-4">â“ ä»Šå¤©åƒä»€ä¹ˆï¼Ÿ</h2>
                <div class="space-y-3">
                    <input type="text" id="recommendation-query" placeholder="æˆ‘æƒ³åƒç‚¹æ¸…æ·¡çš„... / éšä¾¿æ¥ä¸ªå®¶å¸¸èœ" class="w-full p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                    <button id="recommend-button" onclick="handleRecommendation()" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-150 transform hover:scale-[1.01]">
                        éšæœºæŠ½ä¸€ä¸ªèœï¼ğŸ½ï¸
                    </button>
                    <p id="recommendation-result" class="mt-4 p-3 bg-white border border-green-400 rounded-lg text-lg font-medium text-gray-700 min-h-[4rem] flex items-center justify-center text-center">
                        å‘Šè¯‰æˆ‘ä½ æƒ³åƒä»€ä¹ˆå§ï¼
                    </p>
                </div>
            </section>
            
            <!-- 3. å·²ä¿å­˜èœå•æ¦‚è§ˆ -->
            <section>
                <h2 class="text-xl font-bold text-gray-700 mb-4">ğŸ“– å·²ä¿å­˜çš„èœå• (<span id="menu-count">0</span> é¡¹)</h2>
                
                <!-- åˆ†ç±»æ ‡ç­¾å’Œè¿‡æ»¤ -->
                <div id="category-filter-container" class="flex flex-wrap gap-2 mb-4 custom-scrollbar overflow-x-auto pb-2">
                    <!-- æ ‡ç­¾ç”± JS å¡«å…… -->
                </div>

                <div id="menu-list" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar p-2 -m-2">
                    <p id="empty-message" class="text-gray-400 text-center py-4">æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•èœè‚´ï¼</p>
                    <!-- èœå•é¡¹ç”± JS å¡«å…… -->
                </div>
            </section>

        </div>

    </div>

    <script>
        // =================================================================
        // æœ¬åœ°å­˜å‚¨æ“ä½œ (Local Storage Operations)
        // =================================================================

        const LOCAL_STORAGE_KEY = 'menuPlannerLocalData';
        window.menuItems = []; 
        window.currentFilter = 'All'; 

        /**
         * ä» localStorage åŠ è½½æ•°æ®
         * @returns {Array<Object>}
         */
        function loadLocalData() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥:", e);
                return [];
            }
        }
        
        /**
         * ä¿å­˜æ•°æ®åˆ° localStorage å¹¶æ›´æ–° UI
         * @param {Array<Object>} data - è¦ä¿å­˜çš„æ•°æ®
         */
        function saveLocalDataAndRefresh(data) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
                window.menuItems = data;
                renderMenuItems(data, window.currentFilter);
                renderCategoryFilters(data);
            } catch (e) {
                console.error("ä¿å­˜æœ¬åœ°æ•°æ®å¤±è´¥:", e);
                displayMessage('save-message', 'æœ¬åœ°å­˜å‚¨ç©ºé—´å·²æ»¡æˆ–å‘ç”Ÿé”™è¯¯ï¼', 'error');
            }
        }
        
        // =================================================================
        // å®ç”¨å‡½æ•° (Utility Functions)
        // =================================================================

        /**
         * æ˜¾ç¤ºé”™è¯¯æˆ–çŠ¶æ€æ¶ˆæ¯
         */
        function displayMessage(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            if (!el) return;

            el.textContent = message;
            el.className = 'text-sm text-center pt-1';
            
            if (type === 'success') {
                el.classList.add('text-green-600', 'font-semibold');
            } else if (type === 'error') {
                el.classList.add('text-red-600', 'font-semibold');
            } else {
                el.classList.add('text-gray-500');
            }

            setTimeout(() => {
                el.textContent = '';
                el.className = 'text-sm text-center pt-1';
            }, 3000);
        }

        // =================================================================
        // æ•°æ®æ“ä½œ (Data Operations)
        // =================================================================

        /**
         * ä¿å­˜æ–°èœè‚´åˆ°æœ¬åœ°å­˜å‚¨
         */
        window.saveDish = function() {
            const nameInput = document.getElementById('dish-name');
            const categoryInput = document.getElementById('dish-category');
            const name = nameInput.value.trim();
            // ç»Ÿä¸€è½¬æ¢ä¸ºå°å†™ï¼Œä¾¿äºç­›é€‰å’ŒåŒ¹é…
            let category = categoryInput.value.trim().toLowerCase() || 'å…¶ä»–'; 

            if (!name) {
                displayMessage('save-message', 'èœåä¸èƒ½ä¸ºç©ºï¼', 'error');
                return;
            }
            
            const newDish = {
                // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
                id: Date.now().toString(), 
                name: name,
                category: category,
                createdAt: new Date().toISOString()
            };

            try {
                const currentData = loadLocalData();
                currentData.push(newDish);
                saveLocalDataAndRefresh(currentData);

                displayMessage('save-message', `${name} ä¿å­˜æˆåŠŸï¼`, 'success');
                nameInput.value = '';
                categoryInput.value = '';

            } catch (error) {
                console.error("ä¿å­˜èœè‚´å¤±è´¥:", error);
                displayMessage('save-message', `ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        /**
         * ä»æœ¬åœ°å­˜å‚¨ä¸­åˆ é™¤èœå•é¡¹
         * @param {string} dishId - è¦åˆ é™¤çš„å”¯ä¸€ID
         */
        window.deleteDish = function(dishId, dishName) {
            // ä½¿ç”¨æ ‡å‡†çš„ JavaScript ç¡®è®¤æ¡†ï¼Œåœ¨ Safari ä¸Šå¯ä»¥æ­£å¸¸å·¥ä½œ
            if (!window.confirm(`ç¡®å®šè¦åˆ é™¤èœå•é¡¹ "${dishName}" å—ï¼Ÿ`)) return;

            try {
                const currentData = loadLocalData();
                const updatedData = currentData.filter(item => item.id !== dishId);
                saveLocalDataAndRefresh(updatedData);
            } catch (error) {
                console.error("åˆ é™¤èœå•é¡¹å¤±è´¥:", error);
                displayMessage('save-message', 'åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®ã€‚', 'error');
            }
        }
        
        // =================================================================
        // UI æ¸²æŸ“ (UI Rendering)
        // =================================================================
        
        /**
         * æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶æ¸²æŸ“èœå•åˆ—è¡¨
         */
        function renderMenuItems(items, filter) {
            const menuListEl = document.getElementById('menu-list');
            const menuCountEl = document.getElementById('menu-count');
            const emptyMessageEl = document.getElementById('empty-message');
            
            menuListEl.innerHTML = '';
            
            const filteredItems = filter === 'All' 
                ? items 
                : items.filter(item => item.category === filter.toLowerCase());

            menuCountEl.textContent = items.length;
            
            if (filteredItems.length === 0) {
                emptyMessageEl.classList.remove('hidden');
            } else {
                emptyMessageEl.classList.add('hidden');
            }

            filteredItems.forEach(item => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200 transition duration-100 hover:shadow-sm";
                // ä½¿ç”¨ item.id è¿›è¡Œåˆ é™¤æ“ä½œ
                div.innerHTML = `
                    <div class="flex-grow">
                        <span class="text-gray-900 font-medium">${item.name}</span>
                        <span class="ml-3 inline-block text-xs font-mono bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full">${item.category}</span>
                    </div>
                    <button onclick="deleteDish('${item.id}', '${item.name.replace(/'/g, "\\'")}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                menuListEl.appendChild(div);
            });
        }
        
        /**
         * æ¸²æŸ“åˆ†ç±»ç­›é€‰æ ‡ç­¾
         */
        function renderCategoryFilters(items) {
            const container = document.getElementById('category-filter-container');
            container.innerHTML = '';
            
            // æå–æ‰€æœ‰å”¯ä¸€åˆ†ç±»ï¼Œå¹¶é¦–å­—æ¯å¤§å†™æ˜¾ç¤º
            const categories = ['All', ...new Set(items.map(item => item.category))].map(c => c.charAt(0).toUpperCase() + c.slice(1));
            
            categories.forEach(category => {
                const button = document.createElement('button');
                
                const isActive = category === window.currentFilter;
                
                button.className = `px-3 py-1 text-sm font-medium rounded-full transition duration-150 whitespace-nowrap ${
                    isActive 
                    ? 'bg-indigo-600 text-white shadow-md' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`;
                button.textContent = category;
                
                button.onclick = () => {
                    window.currentFilter = category;
                    renderCategoryFilters(items); 
                    renderMenuItems(items, category); 
                };
                
                container.appendChild(button);
            });
        }

        // =================================================================
        // éšæœºæ¨èé€»è¾‘ (Random Recommendation Logic)
        // =================================================================
        
        /**
         * æœ¬åœ°æ¨¡å¼ä¸‹çš„ç®€å•å…³é”®è¯åŒ¹é…
         */
        function simpleLocalCategoryMatch(query, categories) {
            const lowerQuery = query.toLowerCase();
            
            // 1. å°è¯•ç›´æ¥åŒ¹é…ç”¨æˆ·è¾“å…¥æ˜¯å¦åŒ…å«ä»»ä½•å·²æœ‰çš„åˆ†ç±»å
            for (const category of categories) {
                if (lowerQuery.includes(category)) {
                    return category;
                }
            }
            
            // 2. ç®€å•çš„å…³é”®è¯æ˜ å°„ï¼ˆæ˜ å°„åˆ°å¸¸è§çš„åˆ†ç±»åï¼‰
            const keywordMap = {
                'è¾£': 'å·èœ', 'æ¸…æ·¡': 'ç´ é£Ÿ', 'å¿«': 'å¿«é¤', 'ç®€å•': 'å¿«é¤',
                'æ±¤': 'æ±¤', 'ç²¥': 'ç²¥', 'æ—©': 'æ—©é¤', 'å®¶å¸¸': 'å®¶å¸¸èœ',
                'é¥­': 'ä¸»é£Ÿ', 'è‚‰': 'è¤èœ', 'é±¼': 'æµ·é²œ'
            };
            
            for (const keyword in keywordMap) {
                if (lowerQuery.includes(keyword)) {
                    // æ£€æŸ¥åŒ¹é…åˆ°çš„åˆ†ç±»æ˜¯å¦å­˜åœ¨äºç”¨æˆ·çš„åˆ†ç±»åˆ—è¡¨ä¸­
                    const matchedCategory = keywordMap[keyword].toLowerCase();
                    if (categories.includes(matchedCategory)) {
                         return matchedCategory;
                    }
                }
            }
            
            // 3. é»˜è®¤è¿”å›ä¸€ä¸ªéšæœºåˆ†ç±»
            const randomIndex = Math.floor(Math.random() * categories.length);
            return categories[randomIndex];
        }

        /**
         * å¤„ç†ç”¨æˆ·çš„éšæœºç‚¹é¤è¯·æ±‚
         */
        window.handleRecommendation = function() {
            const queryInput = document.getElementById('recommendation-query');
            const resultEl = document.getElementById('recommendation-result');
            const recommendBtn = document.getElementById('recommend-button');

            const userQuery = queryInput.value.trim();
            const items = window.menuItems;

            if (!userQuery) {
                resultEl.innerHTML = 'è¯·è¾“å…¥ä½ çš„è¦æ±‚ï¼Œä¾‹å¦‚ï¼šæˆ‘æƒ³åƒç‚¹å¿«é€Ÿçš„æ™šé¤ã€‚';
                return;
            }
            
            if (items.length === 0) {
                resultEl.innerHTML = 'è¯·å…ˆæ·»åŠ èœå•ï¼Œæˆ‘æ‰èƒ½å¸®ä½ æ¨èå“¦ï¼';
                return;
            }

            // æå–å½“å‰æ‰€æœ‰çš„åˆ†ç±»
            const allCategories = [...new Set(items.map(item => item.category))];
            
            recommendBtn.disabled = true;
            recommendBtn.textContent = 'æ€è€ƒä¸­... è¯·ç¨å€™...';
            resultEl.classList.remove('text-lg', 'font-medium');
            
            // 1. å…³é”®è¯åŒ¹é…æœ€ä½³åˆ†ç±»
            const matchedCategory = simpleLocalCategoryMatch(userQuery, allCategories);
            
            // 2. æ ¹æ®åŒ¹é…ç»“æœè¿›è¡Œæœ¬åœ°éšæœºé€‰æ‹©
            let filteredDishes = items.filter(item => item.category === matchedCategory);
            
            let isRandomFallback = false;
            if (filteredDishes.length === 0) {
                filteredDishes = items; // å¤‡ç”¨ï¼šä»æ‰€æœ‰èœä¸­éšæœºé€‰ä¸€ä¸ª
                isRandomFallback = true;
            }
            
            const randomIndex = Math.floor(Math.random() * filteredDishes.length);
            const recommendation = filteredDishes[randomIndex];

            // 3. æ„é€ æœ€ç»ˆçš„æ¨èæ¶ˆæ¯
            const finalMessage = `
                <p class="text-xl font-extrabold text-green-700 mb-2">${recommendation.name}ï¼</p>
                <p class="text-sm text-gray-600">
                    ${isRandomFallback
                        ? `æ‰¾ä¸åˆ°åŒ¹é…çš„ ${matchedCategory} åˆ†ç±»ï¼Œä¸ºæ‚¨ä»æ‰€æœ‰èœä¸­éšæœºæ¨èäº†ï¼š${recommendation.category}` 
                        : `æ ¹æ®æ‚¨çš„è¦æ±‚ (${matchedCategory}) æ¨èï¼Œèœå“åˆ†ç±»æ˜¯ï¼š${recommendation.category}`}
                </p>
            `;

            resultEl.classList.add('text-lg', 'font-medium');
            resultEl.innerHTML = finalMessage;
            
            recommendBtn.disabled = false;
            recommendBtn.textContent = 'éšæœºæŠ½ä¸€ä¸ªèœï¼ğŸ½ï¸';
        }
        
        // =================================================================
        // åˆå§‹åŒ– (Initialization)
        // =================================================================

        /**
         * åœ¨é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨åº”ç”¨
         */
        function initializeApp() {
            // åŠ è½½æœ¬åœ°æ•°æ®å¹¶æ¸²æŸ“UI
            window.menuItems = loadLocalData(); 
            renderMenuItems(window.menuItems, window.currentFilter);
            renderCategoryFilters(window.menuItems);
        }
        
        // ç¡®ä¿åœ¨é¡µé¢å†…å®¹åŠ è½½å®Œæ¯•åå¯åŠ¨
        window.addEventListener('load', initializeApp);

    </script>

</body>
</html>

