<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½èœå•è§„åˆ’ä¸éšæœºç‚¹é¤</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—ä½“ä»¥è·å¾—ç°ä»£æ„Ÿå’Œæ›´å¥½çš„ç§»åŠ¨ç«¯æ˜¾ç¤º */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* å¼ºåˆ¶ä¸»å®¹å™¨åœ¨å°å±å¹•ä¸Šå æ»¡å®½åº¦ */
        #app-container {
            min-height: 100vh;
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #a5b4fc;
            border-radius: 2px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app-container" class="w-full max-w-2xl mx-auto bg-white shadow-2xl rounded-2xl p-6 sm:p-8 lg:p-10">

        <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">ğŸ½ï¸ æ™ºèƒ½èœå•è§„åˆ’</h1>
        <p class="text-sm text-gray-500 mb-6 border-b pb-4">
            èœå•æ•°æ®å·²å®‰å…¨å­˜å‚¨åœ¨æ‚¨çš„äº‘ç«¯ã€‚æ‚¨çš„ç”¨æˆ·ID: 
            <span id="user-id-display" class="font-mono text-xs bg-gray-100 px-1 py-0.5 rounded">Loading...</span>
        </p>

        <!-- åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div id="loading-spinner" class="text-center py-10 hidden">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full"></div>
            <p class="mt-2 text-indigo-600">æ­£åœ¨åŠ è½½æ•°æ®å’Œèº«ä»½éªŒè¯...</p>
        </div>

        <div id="main-content" class="space-y-10 hidden">
            
            <!-- 1. èœå•æ·»åŠ åŒº -->
            <section class="border border-indigo-200 rounded-xl p-4 bg-indigo-50">
                <h2 class="text-xl font-bold text-indigo-700 mb-4">âœ¨ æ·»åŠ æ–°èœå•</h2>
                <div class="space-y-3">
                    <input type="text" id="dish-name" placeholder="è¾“å…¥èœå (ä¾‹å¦‚: å®«ä¿é¸¡ä¸)" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <input type="text" id="dish-category" placeholder="è¾“å…¥åˆ†ç±» (ä¾‹å¦‚: å·èœ, ç´ é£Ÿ, æ—©é¤)" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <button onclick="saveDish()" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01]">
                        ä¿å­˜èœå• ğŸ’¾
                    </button>
                    <p id="save-message" class="text-sm text-center pt-1"></p>
                </div>
            </section>

            <!-- 2. èœå•æ¨è/éšæœºç‚¹é¤åŒº -->
            <section class="border border-green-200 rounded-xl p-4 bg-green-50">
                <h2 class="text-xl font-bold text-green-700 mb-4">â“ ä»Šå¤©åƒä»€ä¹ˆï¼Ÿ</h2>
                <div class="space-y-3">
                    <input type="text" id="recommendation-query" placeholder="æˆ‘æƒ³åƒç‚¹æ¸…æ·¡çš„... / éšä¾¿æ¥ä¸ªå®¶å¸¸èœ" class="w-full p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                    <button id="recommend-button" onclick="handleRecommendation()" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-150 transform hover:scale-[1.01]">
                        éšæœºæŠ½ä¸€ä¸ªèœï¼ğŸ½ï¸
                    </button>
                    <p id="recommendation-result" class="mt-4 p-3 bg-white border border-green-400 rounded-lg text-lg font-medium text-gray-700 min-h-[4rem] flex items-center justify-center text-center">
                        å‘Šè¯‰æˆ‘ä½ æƒ³åƒä»€ä¹ˆå§ï¼
                    </p>
                </div>
            </section>
            
            <!-- 3. å·²ä¿å­˜èœå•æ¦‚è§ˆ -->
            <section>
                <h2 class="text-xl font-bold text-gray-700 mb-4">ğŸ“– å·²ä¿å­˜çš„èœå• (<span id="menu-count">0</span> é¡¹)</h2>
                
                <!-- åˆ†ç±»æ ‡ç­¾å’Œè¿‡æ»¤ -->
                <div id="category-filter-container" class="flex flex-wrap gap-2 mb-4 custom-scrollbar overflow-x-auto pb-2">
                    <!-- æ ‡ç­¾ç”± JS å¡«å…… -->
                </div>

                <div id="menu-list" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar p-2 -m-2">
                    <p id="empty-message" class="text-gray-400 text-center py-4">æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•èœè‚´ï¼</p>
                    <!-- èœå•é¡¹ç”± JS å¡«å…… -->
                </div>
            </section>

        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // å…¨å±€å˜é‡å®šä¹‰ (Global Variables)
        // =================================================================
        // Firestore å¼ºåˆ¶è¦æ±‚ä½¿ç”¨çš„å…¨å±€å˜é‡
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // LLM API é…ç½®
        const API_KEY = ""; // ä¿æŒä¸ºç©ºï¼Œç”±è¿è¡Œæ—¶ç¯å¢ƒæä¾›
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        window.menuItems = []; // å­˜å‚¨æ‰€æœ‰èœå•é¡¹
        window.currentFilter = 'All'; // å½“å‰é€‰ä¸­çš„åˆ†ç±»è¿‡æ»¤å™¨

        // =================================================================
        // å®ç”¨å‡½æ•° (Utility Functions)
        // =================================================================

        /**
         * æ˜¾ç¤ºé”™è¯¯æˆ–çŠ¶æ€æ¶ˆæ¯
         * @param {string} elementId - æ¶ˆæ¯æ˜¾ç¤ºçš„ DOM å…ƒç´  ID
         * @param {string} message - è¦æ˜¾ç¤ºçš„æ¶ˆæ¯
         * @param {string} type - 'success', 'error', 'info'
         */
        function displayMessage(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            if (!el) return;

            el.textContent = message;
            el.className = 'text-sm text-center pt-1';
            
            if (type === 'success') {
                el.classList.add('text-green-600', 'font-semibold');
            } else if (type === 'error') {
                el.classList.add('text-red-600', 'font-semibold');
            } else {
                el.classList.add('text-gray-500');
            }

            setTimeout(() => {
                el.textContent = '';
                el.className = 'text-sm text-center pt-1';
            }, 3000);
        }

        // =================================================================
        // Firebase åˆå§‹åŒ–ä¸è®¤è¯ (Firebase Init & Auth)
        // =================================================================

        /**
         * åˆå§‹åŒ– Firebase åº”ç”¨å¹¶å¤„ç†ç”¨æˆ·è®¤è¯ã€‚
         */
        async function initializeFirebase() {
            try {
                // å¯ç”¨ Firebase æ—¥å¿—
                setLogLevel('debug'); 

                // 1. åˆå§‹åŒ– App å’Œ Services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                window.db = db; // æŒ‚è½½åˆ° window ä¾›å¤–éƒ¨ saveDish è°ƒç”¨

                const loadingSpinner = document.getElementById('loading-spinner');
                const mainContent = document.getElementById('main-content');
                loadingSpinner.classList.remove('hidden');
                mainContent.classList.add('hidden');

                // 2. èº«ä»½éªŒè¯ï¼šä½¿ç”¨ Custom Token æˆ–åŒ¿åç™»å½•
                await new Promise(resolve => {
                    // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–ï¼Œè¿™æ˜¯ç¡®ä¿ userId æ­£ç¡®çš„å…³é”®
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('user-id-display').textContent = userId;
                            isAuthReady = true;
                            resolve();
                        } else if (!isAuthReady) {
                            // å¦‚æœæ˜¯é¦–æ¬¡åŠ è½½ä¸”æ²¡æœ‰ç”¨æˆ·ï¼Œå°è¯•ç™»å½•
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Firebase ç™»å½•å¤±è´¥:", error);
                                // å³ä½¿ç™»å½•å¤±è´¥ï¼Œä¹Ÿç¡®ä¿ isAuthReady ä¸º trueï¼Œé¿å…æ— é™ç­‰å¾…
                                isAuthReady = true;
                                userId = `anonymous-${crypto.randomUUID()}`; // ä½¿ç”¨éšæœºIDä½œä¸ºè®¿å®¢
                                document.getElementById('user-id-display').textContent = 'åŒ¿åç™»å½•å¤±è´¥';
                                resolve();
                            }
                        }
                    });
                });
                
                // 3. è®¤è¯å®Œæˆåï¼Œå¼€å§‹ç›‘å¬æ•°æ®
                if (isAuthReady) {
                    loadingSpinner.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    listenForMenuItems();
                }

            } catch (error) {
                console.error("åˆå§‹åŒ– Firebase å¤±è´¥:", error);
                document.getElementById('loading-spinner').innerHTML = `<p class="text-red-600">åº”ç”¨åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
            }
        }
        
        window.addEventListener('load', initializeFirebase);

        // =================================================================
        // Firestore æ•°æ®æ“ä½œ (Firestore Data Operations)
        // =================================================================

        /**
         * è·å–ç”¨æˆ·èœå•é›†åˆçš„å¼•ç”¨è·¯å¾„
         * @returns {string} é›†åˆè·¯å¾„
         */
        function getCollectionPath() {
            if (!userId) {
                throw new Error("ç”¨æˆ·æœªè®¤è¯ï¼Œæ— æ³•è·å–é›†åˆè·¯å¾„ã€‚");
            }
            // ä½¿ç”¨ private collection path
            return `artifacts/${appId}/users/${userId}/menus`;
        }

        /**
         * ç›‘å¬èœå•é¡¹çš„å®æ—¶å˜åŒ–
         */
        function listenForMenuItems() {
            if (!isAuthReady || !userId || !db) return;

            const menuColRef = collection(db, getCollectionPath());
            
            // ä½¿ç”¨ onSnapshot å®æ—¶ç›‘å¬æ•°æ®å˜åŒ–
            onSnapshot(menuColRef, (snapshot) => {
                const fetchedItems = [];
                snapshot.forEach(doc => {
                    // è§£æ„æ•°æ®ï¼Œå¹¶æ·»åŠ  Firestore document ID
                    fetchedItems.push({ id: doc.id, ...doc.data() });
                });
                
                window.menuItems = fetchedItems;
                renderMenuItems(window.menuItems, window.currentFilter);
                renderCategoryFilters(window.menuItems);
            }, (error) => {
                console.error("ç›‘å¬èœå•æ•°æ®å¤±è´¥:", error);
            });
        }

        /**
         * ä¿å­˜æ–°èœè‚´åˆ° Firestore
         */
        window.saveDish = async function() {
            const nameInput = document.getElementById('dish-name');
            const categoryInput = document.getElementById('dish-category');
            const name = nameInput.value.trim();
            let category = categoryInput.value.trim();

            if (!name) {
                displayMessage('save-message', 'èœåä¸èƒ½ä¸ºç©ºï¼', 'error');
                return;
            }

            // é»˜è®¤åˆ†ç±»
            if (!category) {
                category = 'å…¶ä»–';
            }

            const newDish = {
                name: name,
                category: category.toLowerCase(), // ç»Ÿä¸€è½¬ä¸ºå°å†™ä¾¿äºæœç´¢å’Œåˆ†ç±»
                createdAt: new Date().toISOString(),
                userId: userId
            };

            try {
                const menuColRef = collection(db, getCollectionPath());
                await addDoc(menuColRef, newDish);
                displayMessage('save-message', `${name} ä¿å­˜æˆåŠŸï¼`, 'success');
                nameInput.value = '';
                categoryInput.value = '';
            } catch (error) {
                console.error("ä¿å­˜èœè‚´å¤±è´¥:", error);
                displayMessage('save-message', `ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        /**
         * ä» Firestore ä¸­åˆ é™¤èœå•é¡¹
         * @param {string} dishId - è¦åˆ é™¤çš„ Firestore æ–‡æ¡£ID
         */
        window.deleteDish = async function(dishId, dishName) {
            try {
                // ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†æ›¿ä»£ alert/confirm
                if (!confirm(`ç¡®å®šè¦åˆ é™¤èœå•é¡¹ "${dishName}" å—ï¼Ÿ`)) return;

                const docRef = doc(db, getCollectionPath(), dishId);
                await deleteDoc(docRef);
                console.log(`Successfully deleted dish: ${dishId}`);
                // onSnapshot ä¼šè‡ªåŠ¨æ›´æ–° UI
            } catch (error) {
                console.error("åˆ é™¤èœå•é¡¹å¤±è´¥:", error);
                displayMessage('save-message', 'åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æƒé™ã€‚', 'error');
            }
        }
        
        // =================================================================
        // UI æ¸²æŸ“ (UI Rendering)
        // =================================================================
        
        /**
         * æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶æ¸²æŸ“èœå•åˆ—è¡¨
         * @param {Array<Object>} items - æ‰€æœ‰èœå•é¡¹
         * @param {string} filter - å½“å‰ç­›é€‰çš„åˆ†ç±» ('All' æˆ–å…·ä½“åˆ†ç±»å)
         */
        function renderMenuItems(items, filter) {
            const menuListEl = document.getElementById('menu-list');
            const menuCountEl = document.getElementById('menu-count');
            const emptyMessageEl = document.getElementById('empty-message');
            
            menuListEl.innerHTML = '';
            
            const filteredItems = filter === 'All' 
                ? items 
                : items.filter(item => item.category === filter.toLowerCase());

            menuCountEl.textContent = items.length;
            
            if (filteredItems.length === 0) {
                emptyMessageEl.classList.remove('hidden');
            } else {
                emptyMessageEl.classList.add('hidden');
            }

            filteredItems.forEach(item => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200 transition duration-100 hover:shadow-sm";
                div.innerHTML = `
                    <div class="flex-grow">
                        <span class="text-gray-900 font-medium">${item.name}</span>
                        <span class="ml-3 inline-block text-xs font-mono bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full">${item.category}</span>
                    </div>
                    <button onclick="deleteDish('${item.id}', '${item.name.replace(/'/g, "\\'")}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                menuListEl.appendChild(div);
            });
        }
        
        /**
         * æ¸²æŸ“åˆ†ç±»ç­›é€‰æ ‡ç­¾
         * @param {Array<Object>} items - æ‰€æœ‰èœå•é¡¹
         */
        function renderCategoryFilters(items) {
            const container = document.getElementById('category-filter-container');
            container.innerHTML = '';
            
            // æå–æ‰€æœ‰å”¯ä¸€åˆ†ç±»
            const categories = ['All', ...new Set(items.map(item => item.category))].map(c => c.charAt(0).toUpperCase() + c.slice(1));
            
            categories.forEach(category => {
                const button = document.createElement('button');
                
                const isActive = category === window.currentFilter;
                
                button.className = `px-3 py-1 text-sm font-medium rounded-full transition duration-150 whitespace-nowrap ${
                    isActive 
                    ? 'bg-indigo-600 text-white shadow-md' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`;
                button.textContent = category;
                
                button.onclick = () => {
                    window.currentFilter = category;
                    renderCategoryFilters(items); // é‡æ–°æ¸²æŸ“æ ‡ç­¾ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
                    renderMenuItems(items, category); // é‡æ–°æ¸²æŸ“èœå•åˆ—è¡¨
                };
                
                container.appendChild(button);
            });
        }

        // =================================================================
        // LLM äº¤äº’ä¸æ¨èé€»è¾‘ (LLM Interaction & Recommendation)
        // =================================================================

        /**
         * å¤„ç†ç”¨æˆ·çš„éšæœºç‚¹é¤è¯·æ±‚ï¼ŒåŒ…æ‹¬ LLM äº¤äº’
         */
        window.handleRecommendation = async function() {
            const queryInput = document.getElementById('recommendation-query');
            const resultEl = document.getElementById('recommendation-result');
            const recommendBtn = document.getElementById('recommend-button');

            const userQuery = queryInput.value.trim();
            if (!userQuery) {
                resultEl.innerHTML = 'è¯·è¾“å…¥ä½ çš„è¦æ±‚ï¼Œä¾‹å¦‚ï¼šæˆ‘æƒ³åƒç‚¹å¿«é€Ÿçš„æ™šé¤ã€‚';
                return;
            }
            
            if (window.menuItems.length === 0) {
                resultEl.innerHTML = 'è¯·å…ˆæ·»åŠ èœå•ï¼Œæˆ‘æ‰èƒ½å¸®ä½ æ¨èå“¦ï¼';
                return;
            }

            // æå–å½“å‰æ‰€æœ‰çš„åˆ†ç±»
            const availableCategories = [...new Set(window.menuItems.map(item => item.category))];
            
            recommendBtn.disabled = true;
            recommendBtn.textContent = 'æ€è€ƒä¸­... è¯·ç¨å€™...';
            resultEl.classList.remove('text-lg', 'font-medium');
            resultEl.innerHTML = `<div class="animate-pulse text-sm text-green-600">æ­£åœ¨åˆ†ææ‚¨çš„éœ€æ±‚ï¼Œå¹¶ä» ${availableCategories.length} ä¸ªåˆ†ç±»ä¸­æŒ‘é€‰...</div>`;

            try {
                // 1. è°ƒç”¨ LLM åŒ¹é…ç”¨æˆ·è¯·æ±‚å’Œæœ€ä½³åˆ†ç±»
                const matchedCategory = await getCategoryMatchFromLLM(userQuery, availableCategories);
                
                // 2. æ ¹æ® LLM ç»“æœè¿›è¡Œæœ¬åœ°éšæœºé€‰æ‹©
                let filteredDishes = window.menuItems.filter(item => item.category === matchedCategory);
                
                // å¦‚æœ LLM åŒ¹é…çš„åˆ†ç±»æ²¡æœ‰èœï¼Œåˆ™ä»æ‰€æœ‰èœä¸­éšæœºé€‰ä¸€ä¸ªä½œä¸ºå¤‡é€‰
                if (filteredDishes.length === 0) {
                    filteredDishes = window.menuItems;
                    console.warn(`LLM matched category '${matchedCategory}' but it has no dishes. Switching to full random.`);
                }
                
                const randomIndex = Math.floor(Math.random() * filteredDishes.length);
                const recommendation = filteredDishes[randomIndex];

                // 3. æ„é€ æœ€ç»ˆçš„æ¨èæ¶ˆæ¯
                const finalMessage = `
                    <p class="text-xl font-extrabold text-green-700 mb-2">${recommendation.name}ï¼</p>
                    <p class="text-sm text-gray-600">
                        ${matchedCategory === recommendation.category 
                            ? `å®Œç¾ç¬¦åˆæ‚¨çš„éœ€æ±‚ï¼Œèœå“åˆ†ç±»æ˜¯ï¼š${recommendation.category}` 
                            : `æ‰¾ä¸åˆ°åŒ¹é…é¡¹ï¼Œä¸ºæ‚¨éšæœºæ¨èäº†ï¼š${recommendation.category}`}
                    </p>
                `;

                resultEl.classList.add('text-lg', 'font-medium');
                resultEl.innerHTML = finalMessage;


            } catch (error) {
                console.error("æ¨èå¤±è´¥:", error);
                resultEl.innerHTML = `<p class="text-red-500 text-sm">æ¨èå¤±è´¥ï¼š${error.message}ã€‚è¯·æ£€æŸ¥æ‚¨çš„èœå•åˆ—è¡¨æˆ–ç¨åå†è¯•ã€‚</p>`;
            } finally {
                recommendBtn.disabled = false;
                recommendBtn.textContent = 'éšæœºæŠ½ä¸€ä¸ªèœï¼ğŸ½ï¸';
            }
        }

        /**
         * è°ƒç”¨ Gemini APIï¼Œå°†ç”¨æˆ·è¾“å…¥æ˜ å°„åˆ°æœ€åˆé€‚çš„èœè‚´åˆ†ç±»ã€‚
         * @param {string} userQuery - ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢
         * @param {Array<string>} categories - å¯ç”¨çš„åˆ†ç±»åˆ—è¡¨
         * @returns {Promise<string>} åŒ¹é…åˆ°çš„åˆ†ç±»å
         */
        async function getCategoryMatchFromLLM(userQuery, categories) {
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é£Ÿè°±åŒ¹é…åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æç”¨æˆ·çš„è‡ªç„¶è¯­è¨€è¯·æ±‚ï¼Œå¹¶ä»æä¾›çš„åˆ†ç±»åˆ—è¡¨ä¸­ï¼ˆ${categories.join(', ')}ï¼‰é€‰æ‹©æœ€åŒ¹é…çš„ä¸€ä¸ªã€‚å¦‚æœç”¨æˆ·çš„è¯·æ±‚ä¸ä»»ä½•åˆ†ç±»éƒ½ä¸ç›´æ¥åŒ¹é…ï¼Œè¯·é€‰æ‹©ä¸€ä¸ªæœ€æ¥è¿‘æˆ–æœ€åˆç†çš„åˆ†ç±»ã€‚ä½ å¿…é¡»**åª**è¿”å›ä¸€ä¸ªJSONå¯¹è±¡ã€‚`;

            const payload = {
                contents: [{ parts: [{ text: `ç”¨æˆ·è¯·æ±‚: ${userQuery}. å¯ç”¨åˆ†ç±»: ${categories.join(', ')}. è¯·é€‰æ‹©æœ€ä½³åˆ†ç±»ã€‚` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "matchedCategory": { 
                                "type": "STRING", 
                                "description": `ä» [${categories.join(', ')}] ä¸­é€‰å‡ºçš„æœ€ä½³åŒ¹é…åˆ†ç±»ã€‚` 
                            }
                        },
                        required: ["matchedCategory"]
                    }
                }
            };
            
            // ä½¿ç”¨æŒ‡æ•°é€€é¿è¿›è¡Œ API è°ƒç”¨
            let responseJson = null;
            const MAX_RETRIES = 3;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < MAX_RETRIES - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Retry
                        }
                        throw new Error(`API response status: ${response.status}`);
                    }
                    
                    responseJson = await response.json();
                    break; // Success

                } catch (error) {
                    if (i === MAX_RETRIES - 1) throw error; // Re-throw on last attempt
                }
            }


            const candidate = responseJson.candidates?.[0];
            if (candidate && candidate.content?.parts?.[0]?.text) {
                const jsonText = candidate.content.parts[0].text;
                const parsedJson = JSON.parse(jsonText);
                return parsedJson.matchedCategory.toLowerCase(); // ç¡®ä¿è¿”å›å°å†™åŒ¹é…æœ¬åœ°æ•°æ®
            } else {
                throw new Error("æœªèƒ½ä»AIè·å–æœ‰æ•ˆçš„åˆ†ç±»åŒ¹é…ç»“æœã€‚");
            }
        }

    </script>

</body>
</html>

