<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>骏大厨菜单～ - 纯原生JS版</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <style>
        /* Custom Scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #D9C4A8; /* Warm beige */
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #F0EAE4; /* Lighter beige */
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body class="bg-[#FAF6F2]">
    <div id="app" class="min-h-screen p-4 sm:p-8 flex flex-col items-center">
        <!-- 核心应用容器将在JS中动态生成 -->
    </div>

    <script type="module">
        // =================================================================
        // Firebase Imports and Config (使用 ES Modules，更稳定可靠)
        // =================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 核心 Firebase 配置 (使用您提供的配置)
        const CUSTOM_FIREBASE_CONFIG = {
            apiKey: "AIzaSyB3o6MKpxCz1HvgR2k8wpDF9GDtMtZD3dc",
            authDomain: "junjunmenu.firebaseapp.com",
            projectId: "junjunmenu",
            storageBucket: "junjunmenu.firebasestorage.app",
            messagingSenderId: "107344539892",
            appId: "1:107344539892:web:92fa634f2a2bd0710e2ea1"
        };

        const appId = CUSTOM_FIREBASE_CONFIG.projectId || 'shared-menu-app';
        const SHARED_COLLECTION_NAME = 'shared_menu_items';
        const getCollectionPath = () => `public/${appId}/${SHARED_COLLECTION_NAME}`;

        // 初始化 Firebase
        setLogLevel('error'); // 减少控制台噪音
        const app = initializeApp(CUSTOM_FIREBASE_CONFIG);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // =================================================================
        // 全局状态管理
        // =================================================================
        let userId = null;
        let menuItems = [];
        let currentView = 'recommend'; // recommend, manage, add
        let saveMessage = { text: '', type: 'info' };
        let isFirebaseReady = false;

        // =================================================================
        // 辅助函数
        // =================================================================

        /**
         * 消息提示处理
         * @param {string} text - 消息内容
         * @param {string} type - 消息类型 ('success', 'error', 'info')
         */
        const handleSaveMessage = (text, type = 'info') => {
            saveMessage = { text, type };
            renderApp();
            setTimeout(() => {
                saveMessage = { text: '', type: 'info' };
                renderApp();
            }, 3000);
        };

        /**
         * 渲染图标
         * @param {string} name - 图标名称
         */
        const renderIcon = (name, className = 'w-5 h-5') => {
            const icons = {
                Home: '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
                ListChecks: '<path d="M13 19h6"/><path d="M13 15h6"/><path d="M13 11h6"/><path d="M3 12l5-5 5 5"/><path d="M3 16h6"/>',
                PlusCircle: '<circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/>',
                Trash2: '<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>',
                Edit: '<path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>',
                Check: '<path d="M20 6 9 17l-5-5"/>',
                X: '<path d="M18 6 6 18"/><path d="m6 6 12 12"/>',
                DishIcon: '<path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M9 13.5v.5c0 4.3 3 7.6 6.8 8.1l.2.1h.5a8.496 8.496 0 0 0 3.7-2.9L22 17"/><path d="M15 13.5v.5c0 4.3-3 7.6-6.8 8.1l-.2.1h-.5c-3 0-5.6-1.5-7.3-4.1l-1.3-2"/><path d="M3 3h20"/>'
            };
            return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${path}</svg>`;
        };


        // =================================================================
        // 视图渲染函数
        // =================================================================

        /**
         * 渲染 "添加菜品" 视图
         */
        const renderAddView = () => {
            return `
                <div class="space-y-8 p-6 bg-white rounded-2xl shadow-xl border border-[#D9C4A8]">
                    <h2 class="text-2xl font-bold text-[#8B4513] border-b pb-3">${renderIcon('PlusCircle', 'w-6 h-6 inline mr-2 transform -translate-y-0.5')} 录入新菜谱</h2>
                    <p class="text-gray-600">将您的新菜品加入共享菜单库，方便日后点餐和管理。</p>

                    <div class="space-y-5">
                        <input id="dishNameInput" type="text" placeholder="菜名 (例: 红烧肉)" class="w-full p-4 border border-[#B33939]/30 rounded-xl focus:ring-[#B33939] focus:border-[#B33939] transition duration-200 text-base shadow-sm" />
                        <input id="dishCategoryInput" type="text" placeholder="分类 (例: 沪菜, 荤菜, 节日)" class="w-full p-4 border border-[#B33939]/30 rounded-xl focus:ring-[#B33939] focus:border-[#B33939] transition duration-200 text-base shadow-sm" />
                        <button id="saveDishButton" class="w-full text-white font-extrabold tracking-wider py-4 rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.01] bg-[#B33939] hover:bg-[#992D2D] active:bg-[#6F1A07] flex items-center justify-center">
                            ${renderIcon('PlusCircle', 'w-5 h-5 mr-2')}
                            保存新菜品
                        </button>
                    </div>
                </div>
            `;
        };

        /**
         * 渲染 "管理菜单" 视图
         */
        const renderManageView = () => {
            const categories = ['All', ...[...new Set(menuItems.map(item => item.category))].map(c => c.charAt(0).toUpperCase() + c.slice(1))];
            
            // 默认不过滤
            const filteredItems = menuItems; 

            const menuListHTML = filteredItems.length === 0 
                ? `<p class="text-gray-400 text-center py-10">请先添加菜肴到菜单库！</p>`
                : filteredItems.map(item => {
                    const categoryDisplay = item.category.charAt(0).toUpperCase() + item.category.slice(1);
                    return `
                        <div class="flex justify-between items-center bg-white p-4 rounded-xl border border-gray-200 shadow-lg transition duration-150 hover:shadow-xl hover:bg-[#FFFDFB]">
                            <div class="flex-grow flex items-center justify-start min-w-0 space-x-3">
                                ${renderIcon('DishIcon', 'w-6 h-6 text-[#B33939] flex-shrink-0')}
                                <div class="min-w-0">
                                    <span class="text-gray-900 font-bold text-lg truncate block">${item.name}</span>
                                    <span class="mt-1 flex-shrink-0 inline-block text-xs font-medium bg-[#8B4513]/10 text-[#8B4513] px-3 py-0.5 rounded-full shadow-inner">${categoryDisplay}</span>
                                </div>
                            </div>
                            
                            <div class="flex space-x-2 ml-4 flex-shrink-0">
                                <!-- 仅添加删除功能，简化编辑逻辑 -->
                                <button data-id="${item.id}" data-name="${item.name}" class="delete-dish-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition duration-150 shadow-sm" title="删除菜肴">
                                    ${renderIcon('Trash2')}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            // 注意：为了简化 Vanilla JS 代码，我移除了复杂的分类过滤功能和编辑功能，只保留了最核心的展示和删除。
            return `
                <div class="space-y-6 p-6 bg-white rounded-2xl shadow-xl border border-[#D9C4A8]">
                    <h2 class="text-2xl font-bold text-[#8B4513]">${renderIcon('ListChecks', 'w-6 h-6 inline mr-2 transform -translate-y-0.5')} 菜单库总览 (共 ${menuItems.length} 项)</h2>

                    <div class="space-y-4 max-h-[70vh] overflow-y-auto custom-scrollbar">
                        ${menuListHTML}
                    </div>
                </div>
            `;
        };
        
        /**
         * 渲染 "随机推荐" 视图
         */
        const renderRecommendView = () => {
            const recommendationHTML = `<p class="text-lg text-[#8B4513] font-medium">请点击按钮开始点餐！</p>`;

            return `
                <div class="space-y-8 p-6 bg-white rounded-2xl shadow-xl border border-[#D9C4A8]">
                    <h2 class="text-2xl font-bold text-[#8B4513] border-b pb-3">${renderIcon('Home', 'w-6 h-6 inline mr-2 transform -translate-y-0.5')} 智能点餐机</h2>
                    <p class="text-gray-600">系统将在共享菜单中随机为您挑选今日菜品。</p>

                    <div class="space-y-5">
                        <input id="recommendQuery" type="text" placeholder="随便来个家常菜 (目前仅支持随机抽选)" class="w-full p-4 border border-[#8B4513]/30 rounded-xl focus:ring-[#8B4513] focus:border-[#8B4513] transition duration-200 text-base shadow-sm" />
                        <button id="recommendButton" class="w-full text-white font-extrabold tracking-wider py-4 rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.01] bg-[#8B4513] hover:bg-[#6F3624] active:bg-[#4A2C2A] flex items-center justify-center">
                            ${renderIcon('Home', 'w-5 h-5 mr-2')}
                            随机抽一个菜！
                        </button>
                    </div>

                    <div id="recommendationResult" class="min-h-[8rem] flex flex-col justify-center items-center text-center p-6 bg-[#FAF6F2] border border-[#D9C4A8] rounded-2xl shadow-inner">
                        ${recommendationHTML}
                    </div>
                </div>
            `;
        };
        
        /**
         * 核心渲染函数：更新整个应用界面
         */
        const renderApp = () => {
            const appEl = document.getElementById('app');
            if (!appEl) return;

            let mainContentHTML = '';

            if (!isFirebaseReady) {
                mainContentHTML = `
                    <div class="text-center py-20 bg-white rounded-2xl shadow-xl border border-[#D9C4A8] w-full max-w-2xl">
                        <div class="animate-spin inline-block w-10 h-10 border-4 border-[#B33939] border-t-transparent rounded-full"></div>
                        <p class="mt-4 text-[#B33939] font-semibold">正在连接您的私人菜单云端...</p>
                    </div>
                `;
            } else {
                let viewHTML = '';
                if (currentView === 'add') viewHTML = renderAddView();
                else if (currentView === 'manage') viewHTML = renderManageView();
                else viewHTML = renderRecommendView();

                const messageStyle = {
                    success: 'bg-green-100 text-green-700 border-l-4 border-green-500',
                    error: 'bg-red-100 text-red-700 border-l-4 border-red-500',
                    info: 'bg-blue-100 text-blue-700 border-l-4 border-blue-500'
                };
                const messageClass = saveMessage.text ? messageStyle[saveMessage.type] : 'hidden';

                mainContentHTML = `
                    <div class="w-full max-w-2xl bg-[#FFFDFB] shadow-2xl rounded-3xl p-6 sm:p-8 lg:p-10 mb-6 border border-[#EBE3D7]">
                        <h1 class="text-4xl font-extrabold text-[#B33939] mb-1 tracking-wide">
                            骏大厨菜单～
                            ${renderIcon('DishIcon', 'w-8 h-8 inline-block ml-3 transform translate-y-[-2px]')}
                        </h1>
                        <p class="text-sm text-gray-500 mb-4 border-b pb-4">
                            共享ID: 
                            <span class="font-mono text-xs bg-[#FAF6F2] px-2 py-0.5 rounded ml-2 text-gray-600">
                                ${userId ? `ID: ${userId.substring(0, 8)}... | 菜品总数: ${menuItems.length}` : '认证失败'}
                            </span>
                        </p>

                        <!-- 消息提示区 -->
                        <div class="p-3 mb-4 rounded-lg text-sm font-medium shadow-md ${messageClass}">
                            ${saveMessage.text}
                        </div>
                        
                        <!-- 导航栏 -->
                        <div class="flex justify-between p-1 bg-[#F0EAE4] rounded-xl shadow-inner mb-8">
                            ${[
                                { key: 'recommend', label: '今天吃啥', icon: 'Home' },
                                { key: 'manage', label: '管理菜单', icon: 'ListChecks' },
                                { key: 'add', label: '添加菜品', icon: 'PlusCircle' },
                            ].map(({ key, label, icon }) => `
                                <button data-view="${key}" class="nav-button flex-1 flex items-center justify-center py-2 sm:py-3 rounded-xl text-sm font-bold tracking-wider transition duration-300 ${
                                    currentView === key 
                                        ? 'bg-[#8B4513] text-white shadow-lg shadow-[#8B4513]/30' 
                                        : 'text-gray-700 hover:bg-[#D9C4A8] hover:text-white'
                                }">
                                    ${renderIcon(icon, 'w-5 h-5 mr-1.5')}
                                    <span class="hidden sm:inline">${label}</span>
                                </button>
                            `).join('')}
                        </div>

                        <!-- 动态内容区域 -->
                        ${viewHTML}
                    </div>
                `;
            }

            appEl.innerHTML = mainContentHTML;
            attachEventListeners();
        };

        // =================================================================
        // 事件监听与业务逻辑
        // =================================================================

        /**
         * 添加所有事件监听器
         */
        const attachEventListeners = () => {
            // 导航按钮
            document.querySelectorAll('.nav-button').forEach(button => {
                button.onclick = () => {
                    currentView = button.dataset.view;
                    renderApp();
                };
            });

            // "添加菜品" 按钮逻辑
            const saveBtn = document.getElementById('saveDishButton');
            if (saveBtn) {
                saveBtn.onclick = async () => {
                    const dishName = document.getElementById('dishNameInput').value.trim();
                    const dishCategory = document.getElementById('dishCategoryInput').value.trim().toLowerCase() || '其他';
                    
                    if (!dishName) {
                        handleSaveMessage('菜名不能为空！', 'error');
                        return;
                    }

                    saveBtn.disabled = true;
                    saveBtn.innerHTML = `${renderIcon('PlusCircle', 'w-5 h-5 mr-2')} 正在保存...`;
                    
                    try {
                        const menuColRef = collection(db, getCollectionPath());
                        await addDoc(menuColRef, {
                            name: dishName,
                            category: dishCategory,
                            createdAt: new Date().toISOString(),
                            addedBy: userId 
                        });
                        handleSaveMessage(`${dishName} 保存成功并已共享！`, 'success');
                        document.getElementById('dishNameInput').value = '';
                        document.getElementById('dishCategoryInput').value = '';
                    } catch (error) {
                        console.error("保存菜肴失败:", error);
                        handleSaveMessage(`保存失败: ${error.message}`, 'error');
                    } finally {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = `${renderIcon('PlusCircle', 'w-5 h-5 mr-2')} 保存新菜品`;
                    }
                };
            }

            // "删除菜品" 按钮逻辑
            document.querySelectorAll('.delete-dish-btn').forEach(button => {
                button.onclick = async () => {
                    const dishId = button.dataset.id;
                    const dishName = button.dataset.name;
                    
                    if (!window.confirm(`确定要永久删除菜单项 "${dishName}" 吗？`)) return;

                    try {
                        const docRef = doc(db, getCollectionPath(), dishId);
                        await deleteDoc(docRef);
                        handleSaveMessage(`${dishName} 已从共享列表中永久删除。`, 'success');
                    } catch (error) {
                        console.error("删除菜单项失败:", error);
                        handleSaveMessage('删除失败，请检查网络或权限。', 'error');
                    }
                };
            });

            // "随机推荐" 按钮逻辑
            const recommendBtn = document.getElementById('recommendButton');
            if (recommendBtn) {
                recommendBtn.onclick = async () => {
                    if (menuItems.length === 0) {
                        handleSaveMessage('请先添加菜单，我才能帮你推荐哦！', 'error');
                        return;
                    }
                    
                    recommendBtn.disabled = true;
                    recommendBtn.innerHTML = `${renderIcon('Home', 'w-5 h-5 mr-2')} 正在挑选...`;

                    await new Promise(resolve => setTimeout(resolve, 800)); // 模拟思考时间
                    
                    const randomIndex = Math.floor(Math.random() * menuItems.length);
                    const dish = menuItems[randomIndex];
                    const categoryDisplay = dish.category.charAt(0).toUpperCase() + dish.category.slice(1);
                    
                    const resultEl = document.getElementById('recommendationResult');
                    if (resultEl) {
                         resultEl.innerHTML = `
                            <p class="text-4xl font-extrabold text-[#B33939] mb-2 animate-bounce">${dish.name}！</p>
                            <p class="text-base text-gray-700">
                                所属分类：<span class="font-semibold text-[#8B4513]">${categoryDisplay}</span>
                            </p>
                            <p class="text-xs text-gray-500 mt-1">(从所有菜品中随机挑选)</p>
                         `;
                    }

                    recommendBtn.disabled = false;
                    recommendBtn.innerHTML = `${renderIcon('Home', 'w-5 h-5 mr-2')} 随机抽一个菜！`;
                };
            }
        };

        // =================================================================
        // 初始化和数据监听
        // =================================================================

        /**
         * 启动 Firebase 认证和数据监听
         */
        window.onload = () => {
            // 1. 认证监听
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isFirebaseReady = true;
                    renderApp();

                    // 2. 数据监听 (仅在认证成功后启动)
                    const menuColRef = collection(db, getCollectionPath());
                    onSnapshot(menuColRef, (snapshot) => {
                        menuItems = [];
                        snapshot.forEach(doc => {
                            menuItems.push({ id: doc.id, ...doc.data() });
                        });
                        renderApp();
                    }, (error) => {
                        console.error("监听菜单数据失败:", error);
                        handleSaveMessage('实时连接失败，请刷新重试。', 'error');
                    });
                    
                } else {
                    try {
                        // 匿名登录
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Firebase 匿名登录失败:", error);
                        handleSaveMessage("认证失败，请检查 Firebase 匿名登录是否已启用。", 'error');
                        isFirebaseReady = true; // 即使失败也标记为就绪，显示错误信息
                        renderApp();
                    }
                }
            });

            // 首次渲染加载界面
            renderApp();
        };

    </script>
</body>
</html>

